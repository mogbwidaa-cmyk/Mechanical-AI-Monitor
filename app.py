import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import datetime
import requests

# --- 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Ù…Ù†ØµØ© Ù…. Ù…Ø¬Ø§Ù‡Ø¯ Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…Ø¹Ø¯Ø§Øª", page_icon="âš™ï¸", layout="wide")

# --- 2. Ø¥Ø¯Ø§Ø±Ø© Ø³Ø¬Ù„ Ø§Ù„Ø£Ø­Ø¯Ø§Ø« (Session State) ---
# Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠÙ‚ÙˆÙ… Ø¨ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„ØªÙŠ ØªØªÙ… Ø®Ù„Ø§Ù„ Ø§Ù„Ø¬Ù„Ø³Ø©
if 'event_log' not in st.session_state:
    st.session_state.event_log = []

# --- 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø±Ø¨Ø· ÙˆØ§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª ---
TELEGRAM_TOKEN = "8050369942:AAEN-n0Qn-kAmu_9k-lqZ9Fe-tsAOSd44OA"
CHAT_ID = "6241195886"

def send_intelligent_alert(factory_name, machine_name, vibration, status, fault_type):
    now = datetime.datetime.now().strftime("%H:%M - %Y/%m/%d")
    message = (
        f"ğŸ¢ **Ù…Ù†Ø´Ø£Ø©: {factory_name}**\n"
        f"ğŸš¨ **Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¬Ø§Ù‡Ø¯ Ø§Ù„Ø°ÙƒÙŠ**\n\n"
        f"ğŸ“… Ø§Ù„ÙˆÙ‚Øª: {now}\n"
        f"âš™ï¸ Ø§Ù„Ù…Ø¹Ø¯Ø©: {machine_name}\n"
        f"ğŸ“Š Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø²: {vibration} mm/s\n"
        f"âš ï¸ Ø§Ù„Ø­Ø§Ù„Ø©: {status}\n"
        f"ğŸ” Ø§Ù„ØªØ´Ø®ÙŠØµ: {fault_type}"
    )
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage?chat_id={CHAT_ID}&text={message}&parse_mode=Markdown"
    try: 
        requests.get(url)
        # Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¥Ù„Ù‰ Ø§Ù„Ø³Ø¬Ù„
        st.session_state.event_log.insert(0, {
            "Ø§Ù„ÙˆÙ‚Øª": now,
            "Ø§Ù„Ù…Ù†Ø´Ø£Ø©": factory_name,
            "Ø§Ù„Ù…Ø¹Ø¯Ø©": machine_name,
            "Ø§Ù„Ø­Ø§Ù„Ø©": status,
            "Ø§Ù„ØªØ´Ø®ÙŠØµ": fault_type
        })
    except: pass

# --- 4. Ù…Ø­Ø±Ùƒ Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨Ø¤ÙŠ ---
def predict_failure_date(vibration):
    days_left = max(1, int(150 / (vibration + 0.1)))
    fail_date = datetime.date.today() + datetime.timedelta(days=days_left)
    return days_left, fail_date

# --- 5. Ø¯Ø§Ù„Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø·ÙˆØ± ---
def generate_pro_report(factory, machine, vibration, status, fault, temp, days, f_date):
    report = f"""
    ==========================================
    TECHNICAL INSPECTION REPORT - PRO VERSION
    ==========================================
    Engineer: Mogahed Bashir Ahmed
    Date: {datetime.date.today()}
    
    [FACILITY INFO]
    - Location: {factory}
    - Asset ID: {machine}
    
    [LIVE MEASUREMENTS]
    - Vibration: {vibration} mm/s
    - Bearing Temperature: {temp} C
    
    [DIAGNOSTIC RESULTS]
    - Health Status: {status}
    - Identified Fault: {fault}
    
    [PREDICTIVE MAINTENANCE]
    - Estimated Remaining Life: {days} Days
    - Predicted Maintenance Date: {f_date}
    ------------------------------------------
    Generated by Mogahed Smart AI Platform
    """
    return report

# --- 6. Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„ØªØ´Ø®ÙŠØµ ---
def diagnose_fault(vibration):
    if vibration > 7.1: return "Critical: Bearing Failure"
    elif vibration > 4.5: return "Warning: Misalignment"
    return "Normal: Operating within ISO limits"

# --- 7. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/6840/6840478.png", width=80)
    st.title("ğŸ‘¤ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ù‡Ù†ÙŠ")
    st.markdown("### **Ø§Ù„Ù…Ù‡Ù†Ø¯Ø³ Ù…Ø¬Ø§Ù‡Ø¯ Ø¨Ø´ÙŠØ±**")
    st.info("ğŸ“ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ø§Ù„Ù…Ù†ÙˆØ±Ø©ØŒ Ø§Ù„Ø³Ø¹ÙˆØ¯ÙŠØ©")
    st.success("âœ… **Ù„Ù„ØªÙˆØ§ØµÙ„ ÙˆØ§Ù„Ø§Ø³ØªÙØ³Ø§Ø±**")
    st.write("ğŸ“ `+966501318054` ")
    
    linkedin_url = "https://www.linkedin.com/in/mogahed-bashir-52a5072ba/"
    st.markdown(f"""<a href="{linkedin_url}" target="_blank"><img src="https://img.shields.io/badge/LinkedIn-Profile-blue?style=for-the-badge&logo=linkedin" width="100%"></a>""", unsafe_allow_html=True)
    
    st.divider()
    st.header("ğŸ¢ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†Ø´Ø¢Øª")
    selected_factory = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ù†Ø´Ø£Ø©:", ["Madinah Factory", "Jeddah Plant", "Yanbu Industrial"])
    machine_selected = st.selectbox("Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¹Ø¯Ø©:", ["Pump P-01", "Fan F-05", "Compressor C-10"])
    vibration_val = st.slider("Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² (mm/s)", 0.0, 15.0, 3.2)
    temp_val = st.number_input("Ø§Ù„Ø­Ø±Ø§Ø±Ø© (Â°C)", value=55)

# --- 8. Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ---
st.markdown("""
    <div style="background-color:#001529; padding:20px; border-radius:10px; border-right: 8px solid #FFD700; text-align: right; direction: rtl;">
        <h2 style="color:white; margin:0;">ğŸš€ Ù…Ù†ØµØ© Ù…. Ù…Ø¬Ø§Ù‡Ø¯ Ù„Ø£ØªÙ…ØªØ© ÙˆÙ…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ù…ØµØ§Ù†Ø¹</h2>
        <p style="color:#d9d9d9; font-size:18px;">Ù†Ø¸Ø§Ù… Ù…Ø±Ø§Ù‚Ø¨Ø© Ù…Ø±ÙƒØ²ÙŠ Ù…Ø¹ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« ØªÙØ§Ø¹Ù„ÙŠ.</p>
    </div>
    """, unsafe_allow_html=True)

# Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
if vibration_val <= 2.8: status, color = "Good (Safe)", "green"
elif vibration_val <= 7.1: status, color = "Warning", "orange"
else: status, color = "Critical", "red"

fault_type = diagnose_fault(vibration_val)
days_left, fail_date = predict_failure_date(vibration_val)

st.header(f"ğŸ“Š Ø­Ø§Ù„Ø© Ø§Ù„ØªØ´ØºÙŠÙ„: {selected_factory}")

c1, c2, c3 = st.columns([1, 1, 1])
with c1:
    fig = go.Figure(go.Indicator(mode="gauge+number", value=vibration_val, gauge={'bar': {'color': color}, 'axis': {'range': [0, 15]}}))
    st.plotly_chart(fig, use_container_width=True)

with c2:
    st.markdown("### ğŸ¤– ÙˆØ­Ø¯Ø© Ø§Ù„ØªÙ†Ø¨Ø¤ Ø§Ù„Ø°ÙƒÙŠ")
    st.metric("ØªØ§Ø±ÙŠØ® Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ù…ØªÙˆÙ‚Ø¹", f"{fail_date}")
    st.write(f"Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©: **{days_left} ÙŠÙˆÙ…**")
    if st.button("ğŸ“² Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ ÙˆØªÙˆØ«ÙŠÙ‚ Ø§Ù„Ø¹Ù…Ù„ÙŠØ©"):
        send_intelligent_alert(selected_factory, machine_selected, vibration_val, status, fault_type)
        st.success("ØªÙ… Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„")

with c3:
    st.markdown("### ğŸ“¥ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„ÙÙ†ÙŠØ©")
    report_text = generate_pro_report(selected_factory, machine_selected, vibration_val, status, fault_type, temp_val, days_left, fail_date)
    st.download_button(label="ğŸ“¥ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Technical Doc)", data=report_text, file_name=f"Report_{machine_selected}.txt", mime="text/plain", use_container_width=True)

# --- 9. Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙŠØ§Ù†Ø© (Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©) ---
st.divider()
st.subheader("ğŸ“ Ø³Ø¬Ù„ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ØµÙŠØ§Ù†Ø© Ø§Ù„Ø£Ø®ÙŠØ± (Maintenance Log)")
if st.session_state.event_log:
    df_log = pd.DataFrame(st.session_state.event_log)
    st.table(df_log)
else:
    st.info("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø© Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‚Ù… Ø¨Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„.")

st.sidebar.caption("ØªÙ… Ø§Ù„ØªØ·ÙˆÙŠØ± Ø¨ÙˆØ§Ø³Ø·Ø© Ù…. Ù…Ø¬Ø§Ù‡Ø¯ Ø¨Ø´ÙŠØ± - 2026")

