import streamlit as st
import pandas as pd
import numpy as np
import plotly.graph_objects as go
import datetime
import requests

# --- 1. ุฅุนุฏุงุฏุงุช ุงูุตูุญุฉ ---
st.set_page_config(page_title="ููุตุฉ ู. ูุฌุงูุฏ ููุฑุงูุจุฉ ุงููุนุฏุงุช", page_icon="โ๏ธ", layout="wide")

# --- 2. ุฅุฏุงุฑุฉ ุณุฌู ุงูุฃุญุฏุงุซ (Session State) ---
# ูุฐุง ุงูุฌุฒุก ูููู ุจุชุฎุฒูู ุงูุนูููุงุช ุงูุชู ุชุชู ุฎูุงู ุงูุฌูุณุฉ
if 'event_log' not in st.session_state:
    st.session_state.event_log = []

# --- 3. ุฅุนุฏุงุฏุงุช ุงูุฑุจุท ูุงูุชูุจููุงุช ---
TELEGRAM_TOKEN = "8050369942:AAEN-n0Qn-kAmu_9k-lqZ9Fe-tsAOSd44OA"
CHAT_ID = "6241195886"

def send_intelligent_alert(factory_name, machine_name, vibration, status, fault_type):
    now = datetime.datetime.now().strftime("%H:%M - %Y/%m/%d")
    message = (
        f"๐ข **ููุดุฃุฉ: {factory_name}**\n"
        f"๐จ **ูุธุงู ุงููููุฏุณ ูุฌุงูุฏ ุงูุฐูู**\n\n"
        f"๐ ุงูููุช: {now}\n"
        f"โ๏ธ ุงููุนุฏุฉ: {machine_name}\n"
        f"๐ ุงูุงูุชุฒุงุฒ: {vibration} mm/s\n"
        f"โ๏ธ ุงูุญุงูุฉ: {status}\n"
        f"๐ ุงูุชุดุฎูุต: {fault_type}"
    )
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage?chat_id={CHAT_ID}&text={message}&parse_mode=Markdown"
    try: 
        requests.get(url)
        # ุฅุถุงูุฉ ุงูุนูููุฉ ุฅูู ุงูุณุฌู
        st.session_state.event_log.insert(0, {
            "ุงูููุช": now,
            "ุงูููุดุฃุฉ": factory_name,
            "ุงููุนุฏุฉ": machine_name,
            "ุงูุญุงูุฉ": status,
            "ุงูุชุดุฎูุต": fault_type
        })
    except: pass

# --- 4. ูุญุฑู ุงูุชุญููู ุงูุชูุจุคู ---
def predict_failure_date(vibration):
    days_left = max(1, int(150 / (vibration + 0.1)))
    fail_date = datetime.date.today() + datetime.timedelta(days=days_left)
    return days_left, fail_date

# --- 5. ุฏุงูุฉ ุงูุชูุฑูุฑ ุงููุทูุฑ ---
def generate_pro_report(factory, machine, vibration, status, fault, temp, days, f_date):
    report = f"""
    ==========================================
    TECHNICAL INSPECTION REPORT - PRO VERSION
    ==========================================
    Engineer: Mogahed Bashir Ahmed
    Date: {datetime.date.today()}
    
    [FACILITY INFO]
    - Location: {factory}
    - Asset ID: {machine}
    
    [LIVE MEASUREMENTS]
    - Vibration: {vibration} mm/s
    - Bearing Temperature: {temp} C
    
    [DIAGNOSTIC RESULTS]
    - Health Status: {status}
    - Identified Fault: {fault}
    
    [PREDICTIVE MAINTENANCE]
    - Estimated Remaining Life: {days} Days
    - Predicted Maintenance Date: {f_date}
    ------------------------------------------
    Generated by Mogahed Smart AI Platform
    """
    return report

# --- 6. ุฎูุงุฑุฒููุฉ ุงูุชุดุฎูุต ---
def diagnose_fault(vibration):
    if vibration > 7.1: return "Critical: Bearing Failure"
    elif vibration > 4.5: return "Warning: Misalignment"
    return "Normal: Operating within ISO limits"

# --- 7. ุงููุงุฆูุฉ ุงูุฌุงูุจูุฉ ---
with st.sidebar:
    st.image("https://cdn-icons-png.flaticon.com/512/6840/6840478.png", width=80)
    st.title("๐ค ุงูููู ุงููููู")
    st.markdown("### **ุงููููุฏุณ ูุฌุงูุฏ ุจุดูุฑ**")
    st.info("๐ ุงููุฏููุฉ ุงููููุฑุฉุ ุงูุณุนูุฏูุฉ")
    st.success("โ **ูุชุงุญ ููุชูุธูู ููุฑุงู**")
    st.write("๐ `+966501318054` ")
    
    linkedin_url = "https://www.linkedin.com/in/mogahed-bashir-52a5072ba/"
    st.markdown(f"""<a href="{linkedin_url}" target="_blank"><img src="https://img.shields.io/badge/LinkedIn-Profile-blue?style=for-the-badge&logo=linkedin" width="100%"></a>""", unsafe_allow_html=True)
    
    st.divider()
    st.header("๐ข ุฅุฏุงุฑุฉ ุงูููุดุขุช")
    selected_factory = st.selectbox("ุงุฎุชุฑ ุงูููุดุฃุฉ:", ["Madinah Factory", "Jeddah Plant", "Yanbu Industrial"])
    machine_selected = st.selectbox("ุงุฎุชุฑ ุงููุนุฏุฉ:", ["Pump P-01", "Fan F-05", "Compressor C-10"])
    vibration_val = st.slider("ุงูุงูุชุฒุงุฒ (mm/s)", 0.0, 15.0, 3.2)
    temp_val = st.number_input("ุงูุญุฑุงุฑุฉ (ยฐC)", value=55)


# --- 8. ุงููุงุฌูุฉ ุงูุฑุฆูุณูุฉ (ุงููุณู ุงูุชุฑููุฌู ุงููุทูุฑ) ---
st.markdown("""
    <div style="background-color:#001529; padding:30px; border-radius:15px; border-right: 10px solid #FFD700; text-align: right; direction: rtl; box-shadow: 0px 4px 15px rgba(0,0,0,0.3);">
        <h1 style="color:white; margin:0; font-family: 'Cairo', sans-serif;">๐ก๏ธ ููุตุฉ ู. ูุฌุงูุฏ ููุชุญูู ุงูุฑููู ุงูุตูุงุนู</h1>
        <p style="color:#FFD700; font-size:20px; font-weight:bold; margin-top:10px;">ูุญู ุตูุงูุฉ ุฐููุฉ.. ุตูุฑ ุชููู ููุงุฌุฆ!</p>
        <p style="color:#d9d9d9; font-size:16px; line-height:1.6;">
            ูู ุชุนุงูู ูู ุชููู ุงูุฅูุชุงุฌ ุงููุชูุฑุฑุ ูุธุงููุง ุงููุฏุนูู ุจุงูุฐูุงุก ุงูุงุตุทูุงุนู ูููุญู ุงูุณูุทุฑุฉ ุงููุงููุฉ ุนูู ุฃุตููู ุงููููุงููููุฉ:
            <br>โ <b>ุชูุจุค ูุจูุฑ:</b> ูุดู ุงูุฃุนุทุงู ูุจู ูููุนูุง ุจุฃุณุงุจูุน.
            <br>โ <b>ุฎูุถ ุงูุชูุงููู:</b> ุชูููู ูููุงุช ุงูุตูุงูุฉ ุงูุทุงุฑุฆุฉ ุจูุณุจุฉ ุชุตู ุฅูู 30%.
            <br>โ <b>ุฑุจุท ูุญุธู:</b> ุฅุดุนุงุฑุงุช ูุจุงุดุฑุฉ ูุฌูุงู ุงููููุฏุณ ุงููุณุคูู ูุถูุงู ุณุฑุนุฉ ุงูุงุณุชุฌุงุจุฉ.
        </p>
        <hr style="border-color: #334155;">
        <p style="color:white; font-size:14px;">๐๏ธ <i>ุตูู ูุฐุง ุงููุธุงู ุจูุงุณุทุฉ ุฎุจูุฑ ุงูุตูุงูุฉ ุงููููุงููููุฉ ู. ูุฌุงูุฏ ุจุดูุฑ ูุฎุฏูุฉ ุฑุคูุฉ ุงูุณุนูุฏูุฉ 2030 ูู ุชูุทูู ุงูุชูููุงุช ุงูุตูุงุนูุฉ.</i></p>
    </div>
    """, unsafe_allow_html=True)

st.write("") # ูุณุงูุฉ ุฌูุงููุฉ
st.divider()
st.subheader("๐ ุณุฌู ุฃุญุฏุงุซ ุงูุตูุงูุฉ ุงูุฃุฎูุฑ (Maintenance Log)")
if st.session_state.event_log:
    df_log = pd.DataFrame(st.session_state.event_log)
    st.table(df_log)
else:
    st.info("ูุง ุชูุฌุฏ ุฃุญุฏุงุซ ูุณุฌูุฉ ุญุงููุงู. ูู ุจุฅุฑุณุงู ุชูุจูู ูุชูุนูู ุงูุณุฌู.")

st.sidebar.caption("ุชู ุงูุชุทููุฑ ุจูุงุณุทุฉ ู. ูุฌุงูุฏ ุจุดูุฑ - 2026")

